# 存储管理功能使用文档

SaveAny-Bot 现在支持通过 Telegram 机器人动态管理存储配置，用户可以添加、编辑、删除和测试自定义存储端点。

## 功能概述

### 原有功能
- 通过配置文件定义系统级存储端点
- `/storage` 命令选择默认存储位置

### 新增功能
- ✨ **动态存储管理**: 通过 bot 命令管理存储配置
- 🔧 **多种存储类型**: 支持 Alist、WebDAV、MinIO/S3、本地存储、Telegram
- 🧪 **连接测试**: 验证存储配置的有效性
- 🔒 **用户隔离**: 每个用户管理自己的存储配置
- 📊 **状态管理**: 启用/禁用存储配置

## 支持的存储类型

| 存储类型 | 说明 | 需要参数 |
|---------|------|----------|
| **Alist** | Alist 网盘系统 | URL, 用户名, 密码, 路径(可选) |
| **WebDAV** | WebDAV 协议存储 | URL, 用户名, 密码, 路径(可选) |
| **MinIO/S3** | S3 兼容对象存储 | endpoint, access_key, secret_key, bucket, region(可选) |
| **Local** | 本地文件系统 | 本地路径 |
| **Telegram** | Telegram 频道/群组 | chat_id |

## 命令参考

### 基础命令

#### `/storage_list` - 查看存储列表
显示当前用户的所有自定义存储配置，包括状态、类型和创建时间。

```
/storage_list
```

**输出示例**:
```
📚 您的存储配置列表:

🟢 **我的网盘** (alist)
   📝 个人文件存储
   🕐 创建时间: 2025-01-20 15:30:25

🔴 **备份存储** (webdav)
   📝 自动备份用
   🕐 创建时间: 2025-01-19 10:15:30
```

#### `/storage_add` - 添加存储配置
创建新的存储配置。

```
/storage_add <存储名称> [存储类型]
```

**参数说明**:
- `存储名称`: 自定义的存储名称（必需）
- `存储类型`: alist, webdav, minio, local, telegram（可选，默认为 alist）

**使用示例**:
```
/storage_add 我的网盘 alist
/storage_add 本地备份 local
```

#### `/storage_edit` - 编辑存储配置
修改现有存储配置。

```
/storage_edit <存储名称>
```

#### `/storage_delete` - 删除存储配置
删除指定的存储配置（需要确认）。

```
/storage_delete <存储名称>
```

⚠️ **注意**: 无法删除当前设置为默认的存储配置。

#### `/storage_test` - 测试存储连接
验证存储配置是否正确且可访问。

```
/storage_test <存储名称>
```

## 配置向导

### Alist 存储配置

当您选择添加 Alist 存储时，系统会提示您输入配置信息：

```
🔧 配置 Alist 存储

请按以下格式发送配置信息:
URL,用户名,密码[,路径]

示例:
https://alist.example.com,admin,password123,/upload

参数说明:
• URL: Alist 服务器地址
• 用户名: 登录用户名  
• 密码: 登录密码
• 路径: 存储路径 (可选，默认为 /)
```

### WebDAV 存储配置

```
🔧 配置 WebDAV 存储

请按以下格式发送配置信息:
URL,用户名,密码[,路径]

示例:
https://webdav.example.com,user,pass123,/files

参数说明:
• URL: WebDAV 服务器地址
• 用户名: 登录用户名
• 密码: 登录密码  
• 路径: 存储路径 (可选，默认为 /)
```

### MinIO/S3 存储配置

```
🔧 配置 MinIO/S3 存储

请按以下格式发送配置信息:
endpoint,access_key,secret_key,bucket[,region]

示例:
s3.amazonaws.com,AKIAIOSFODNN7EXAMPLE,wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY,my-bucket,us-east-1

参数说明:
• endpoint: S3端点地址
• access_key: 访问密钥ID
• secret_key: 秘密访问密钥
• bucket: 存储桶名称
• region: 区域 (可选，默认为 us-east-1)
```

### 本地存储配置

```
🔧 配置本地存储

请按以下格式发送配置信息:
路径

示例:
/home/user/downloads

参数说明:
• 路径: 本地存储目录的绝对路径
```

### Telegram 存储配置

```
🔧 配置 Telegram 存储

请按以下格式发送配置信息:
chat_id

示例:
-1001234567890

参数说明:
• chat_id: 目标频道或群组的ID (负数)
```

## 使用流程

### 1. 添加新存储

1. 发送 `/storage_add 我的网盘 alist`
2. 系统显示 Alist 配置向导
3. 按格式发送配置信息: `https://alist.example.com,admin,password123,/upload`
4. 系统自动验证配置并测试连接
5. 配置成功后存储被添加到您的列表中

### 2. 查看和管理存储

1. 发送 `/storage_list` 查看所有存储
2. 点击存储名称查看详情
3. 使用按钮进行启用/禁用、编辑、删除等操作

### 3. 测试存储连接

1. 发送 `/storage_test 我的网盘`
2. 系统会尝试连接存储并返回测试结果

### 4. 设置默认存储

1. 发送 `/storage` 命令
2. 从列表中选择要设为默认的存储（包括自定义存储）

## 错误处理

### 常见错误及解决方案

#### 配置验证失败
```
❌ 配置验证失败: Alist存储缺少必需字段: url
```
**解决方案**: 检查配置格式，确保包含所有必需参数。

#### 连接测试失败
```
❌ 存储连接测试失败: 无法访问存储根路径，请检查配置和网络连接
```
**解决方案**: 
- 检查网络连接
- 验证服务器地址是否正确
- 确认用户名和密码是否正确
- 检查防火墙设置

#### 存储名称冲突
```
❌ 存储名称 '我的网盘' 已存在
```
**解决方案**: 使用不同的存储名称或先删除现有的同名存储。

#### 无法删除默认存储
```
❌ 无法删除默认存储，请先设置其他存储为默认
```
**解决方案**: 先使用 `/storage` 命令设置其他存储为默认，然后再删除。

## 安全注意事项

### 数据保护
- 存储凭据以加密形式保存在数据库中
- 每个用户的存储配置完全隔离
- 敏感信息在界面中以 `******` 形式显示

### 权限控制
- 用户只能管理自己创建的存储配置
- 无法访问或修改其他用户的存储设置
- 系统配置的存储仍然全局可用

### 建议
- 定期更换存储服务的访问凭据
- 避免在公共环境中配置存储
- 使用专用的机器人账号而非个人账号

## 技术实现

### 数据库结构
新增 `user_storages` 表存储用户自定义配置：
- 用户ID关联
- 存储名称（用户内唯一）
- 存储类型和配置
- 启用状态和描述信息

### 存储管理器
实现了统一的存储管理接口，整合：
- 系统配置存储（来自 config.toml）
- 用户自定义存储（来自数据库）
- 动态创建和测试存储实例

### 配置验证
多层验证机制：
1. 格式验证（必需字段检查）
2. 类型验证（参数类型转换）
3. 连接测试（实际连通性验证）

## 更新记录

### v1.0.0 (2025-01-20)
- ✨ 新增通过 bot 管理存储配置功能
- 🔧 支持 5 种存储类型的动态配置
- 🧪 实现存储连接测试功能
- 📊 添加存储状态管理（启用/禁用）
- 🔒 实现用户级存储配置隔离
- 📚 完善帮助文档和使用指南

---

如有问题或建议，请通过项目 Issue 反馈。